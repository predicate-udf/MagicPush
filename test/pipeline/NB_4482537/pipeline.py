import sys
sys.path.append("../../../")
sys.path.append("../../")
import z3
import dis
from interface import *
from util import *
import random
from constraint import *
from predicate import *
from generate_input_filters import *
from compare_pushdown_result import get_output_filter, check_pushdown_result
import os

op0 = InitTable("data_0.pickle")
op1 = DropDuplicate(op0, ["timestamp","property","language"])
op2 = SortValues(op1, ["property","timestamp"])
op3 = Filter(op2, Not(IsNULL(Field("language"))))
op4 = SetItem(op3, 'rating', 'lambda xxx__: 1')
op7 = Pivot(op4, 'property','language','rating', None, {'En':'int','aa':'int','ace':'int','aeb-arab':'int','aeb-latn':'int','af':'int','ak':'int','als':'int','am':'int','an':'int','ang':'int','ar':'int','arn':'int','arq':'int','ary':'int','arz':'int','as':'int','ast':'int','atj':'int','ay':'int','az':'int','ba':'int','bar':'int','be':'int','be-tarask':'int','bg':'int','bgn':'int','bh':'int','bho':'int','bn':'int','bpy':'int','br':'int','bs':'int','bxr':'int','ca':'int','cbk-zam':'int','ce':'int','ceb':'int','ckb':'int','co':'int','cs':'int','cy':'int','da':'int','de':'int','de-at':'int','de-ch':'int','de-formal':'int','dsb':'int','dty':'int','ee':'int','el':'int','en':'int','en-ca':'int','en-gb':'int','eo':'int','es':'int','et':'int','eu':'int','fa':'int','fi':'int','fo':'int','fr':'int','frc':'int','frp':'int','frr':'int','fur':'int','fy':'int','ga':'int','gan':'int','gd':'int','gl':'int','glk':'int','gn':'int','gsw':'int','gu':'int','gv':'int','ha':'int','he':'int','hi':'int','hr':'int','hsb':'int','ht':'int','hu':'int','hy':'int','ia':'int','id':'int','ie':'int','ii':'int','ik':'int','ilo':'int','io':'int','is':'int','it':'int','iu':'int','ja':'int','jam':'int','jbo':'int','jv':'int','ka':'int','kg':'int','kk':'int','kl':'int','kn':'int','ko':'int','ksh':'int','ku':'int','ku-latn':'int','ky':'int','la':'int','lb':'int','lfn':'int','li':'int','lij':'int','lmo':'int','ln':'int','lo':'int','lt':'int','lv':'int','mai':'int','mg':'int','mi':'int','min':'int','mk':'int','ml':'int','mn':'int','mr':'int','ms':'int','mt':'int','mwl':'int','my':'int','myv':'int','mzn':'int','nap':'int','nb':'int','nds':'int','nds-nl':'int','ne':'int','nl':'int','nn':'int','no':'int','nov':'int','nrm':'int','nso':'int','oc':'int','olo':'int','or':'int','pa':'int','pam':'int','pcd':'int','pdc':'int','pfl':'int','pi':'int','pl':'int','pms':'int','ps':'int','pt':'int','pt-br':'int','qu':'int','rm':'int','ro':'int','roa-tara':'int','ru':'int','sa':'int','sah':'int','sc':'int','scn':'int','sco':'int','sd':'int','se':'int','sei':'int','sgs':'int','sh':'int','shi':'int','shi-tfng':'int','si':'int','simple':'int','sk':'int','skr-arab':'int','sl':'int','sma':'int','smj':'int','sq':'int','sr':'int','sr-ec':'int','sr-el':'int','stq':'int','su':'int','sv':'int','sw':'int','szl':'int','ta':'int','tcy':'int','te':'int','tg':'int','tg-cyrl':'int','th':'int','tl':'int','tokipona':'int','tr':'int','ts':'int','tt':'int','tt-cyrl':'int','tt-latn':'int','ty':'int','udm':'int','uk':'int','ur':'int','uz':'int','vec':'int','vi':'int','vls':'int','vmf':'int','vo':'int','wa':'int','war':'int','wo':'int','wuu':'int','xh':'int','yi':'int','yo':'int','yue':'int','za':'int','zea':'int','zh':'int','zh-cn':'int','zh-hans':'int','zh-hant':'int','zh-hk':'int','zh-mo':'int','zh-my':'int','zh-sg':'int','zh-tw':'int','zh-yue':'int','zu':'int'})
op7_0 = FillNA(op7, "En", 0)
op7_1 = FillNA(op7_0, "aa", 0)
op7_2 = FillNA(op7_1, "ace", 0)
op7_3 = FillNA(op7_2, "aeb-arab", 0)
op7_4 = FillNA(op7_3, "aeb-latn", 0)
op7_5 = FillNA(op7_4, "af", 0)
op7_6 = FillNA(op7_5, "ak", 0)
op7_7 = FillNA(op7_6, "als", 0)
op7_8 = FillNA(op7_7, "am", 0)
op7_9 = FillNA(op7_8, "an", 0)
op7_10 = FillNA(op7_9, "ang", 0)
op7_11 = FillNA(op7_10, "ar", 0)
op7_12 = FillNA(op7_11, "arn", 0)
op7_13 = FillNA(op7_12, "arq", 0)
op7_14 = FillNA(op7_13, "ary", 0)
op7_15 = FillNA(op7_14, "arz", 0)
op7_16 = FillNA(op7_15, "as", 0)
op7_17 = FillNA(op7_16, "ast", 0)
op7_18 = FillNA(op7_17, "atj", 0)
op7_19 = FillNA(op7_18, "ay", 0)
op7_20 = FillNA(op7_19, "az", 0)
op7_21 = FillNA(op7_20, "ba", 0)
op7_22 = FillNA(op7_21, "bar", 0)
op7_23 = FillNA(op7_22, "be", 0)
op7_24 = FillNA(op7_23, "be-tarask", 0)
op7_25 = FillNA(op7_24, "bg", 0)
op7_26 = FillNA(op7_25, "bgn", 0)
op7_27 = FillNA(op7_26, "bh", 0)
op7_28 = FillNA(op7_27, "bho", 0)
op7_29 = FillNA(op7_28, "bn", 0)
op7_30 = FillNA(op7_29, "bpy", 0)
op7_31 = FillNA(op7_30, "br", 0)
op7_32 = FillNA(op7_31, "bs", 0)
op7_33 = FillNA(op7_32, "bxr", 0)
op7_34 = FillNA(op7_33, "ca", 0)
op7_35 = FillNA(op7_34, "cbk-zam", 0)
op7_36 = FillNA(op7_35, "ce", 0)
op7_37 = FillNA(op7_36, "ceb", 0)
op7_38 = FillNA(op7_37, "ckb", 0)
op7_39 = FillNA(op7_38, "co", 0)
op7_40 = FillNA(op7_39, "cs", 0)
op7_41 = FillNA(op7_40, "cy", 0)
op7_42 = FillNA(op7_41, "da", 0)
op7_43 = FillNA(op7_42, "de", 0)
op7_44 = FillNA(op7_43, "de-at", 0)
op7_45 = FillNA(op7_44, "de-ch", 0)
op7_46 = FillNA(op7_45, "de-formal", 0)
op7_47 = FillNA(op7_46, "dsb", 0)
op7_48 = FillNA(op7_47, "dty", 0)
op7_49 = FillNA(op7_48, "ee", 0)
op7_50 = FillNA(op7_49, "el", 0)
op7_51 = FillNA(op7_50, "en", 0)
op7_52 = FillNA(op7_51, "en-ca", 0)
op7_53 = FillNA(op7_52, "en-gb", 0)
op7_54 = FillNA(op7_53, "eo", 0)
op7_55 = FillNA(op7_54, "es", 0)
op7_56 = FillNA(op7_55, "et", 0)
op7_57 = FillNA(op7_56, "eu", 0)
op7_58 = FillNA(op7_57, "fa", 0)
op7_59 = FillNA(op7_58, "fi", 0)
op7_60 = FillNA(op7_59, "fo", 0)
op7_61 = FillNA(op7_60, "fr", 0)
op7_62 = FillNA(op7_61, "frc", 0)
op7_63 = FillNA(op7_62, "frp", 0)
op7_64 = FillNA(op7_63, "frr", 0)
op7_65 = FillNA(op7_64, "fur", 0)
op7_66 = FillNA(op7_65, "fy", 0)
op7_67 = FillNA(op7_66, "ga", 0)
op7_68 = FillNA(op7_67, "gan", 0)
op7_69 = FillNA(op7_68, "gd", 0)
op7_70 = FillNA(op7_69, "gl", 0)
op7_71 = FillNA(op7_70, "glk", 0)
op7_72 = FillNA(op7_71, "gn", 0)
op7_73 = FillNA(op7_72, "gsw", 0)
op7_74 = FillNA(op7_73, "gu", 0)
op7_75 = FillNA(op7_74, "gv", 0)
op7_76 = FillNA(op7_75, "ha", 0)
op7_77 = FillNA(op7_76, "he", 0)
op7_78 = FillNA(op7_77, "hi", 0)
op7_79 = FillNA(op7_78, "hr", 0)
op7_80 = FillNA(op7_79, "hsb", 0)
op7_81 = FillNA(op7_80, "ht", 0)
op7_82 = FillNA(op7_81, "hu", 0)
op7_83 = FillNA(op7_82, "hy", 0)
op7_84 = FillNA(op7_83, "ia", 0)
op7_85 = FillNA(op7_84, "id", 0)
op7_86 = FillNA(op7_85, "ie", 0)
op7_87 = FillNA(op7_86, "ii", 0)
op7_88 = FillNA(op7_87, "ik", 0)
op7_89 = FillNA(op7_88, "ilo", 0)
op7_90 = FillNA(op7_89, "io", 0)
op7_91 = FillNA(op7_90, "is", 0)
op7_92 = FillNA(op7_91, "it", 0)
op7_93 = FillNA(op7_92, "iu", 0)
op7_94 = FillNA(op7_93, "ja", 0)
op7_95 = FillNA(op7_94, "jam", 0)
op7_96 = FillNA(op7_95, "jbo", 0)
op7_97 = FillNA(op7_96, "jv", 0)
op7_98 = FillNA(op7_97, "ka", 0)
op7_99 = FillNA(op7_98, "kg", 0)
op7_100 = FillNA(op7_99, "kk", 0)
op7_101 = FillNA(op7_100, "kl", 0)
op7_102 = FillNA(op7_101, "kn", 0)
op7_103 = FillNA(op7_102, "ko", 0)
op7_104 = FillNA(op7_103, "ksh", 0)
op7_105 = FillNA(op7_104, "ku", 0)
op7_106 = FillNA(op7_105, "ku-latn", 0)
op7_107 = FillNA(op7_106, "ky", 0)
op7_108 = FillNA(op7_107, "la", 0)
op7_109 = FillNA(op7_108, "lb", 0)
op7_110 = FillNA(op7_109, "lfn", 0)
op7_111 = FillNA(op7_110, "li", 0)
op7_112 = FillNA(op7_111, "lij", 0)
op7_113 = FillNA(op7_112, "lmo", 0)
op7_114 = FillNA(op7_113, "ln", 0)
op7_115 = FillNA(op7_114, "lo", 0)
op7_116 = FillNA(op7_115, "lt", 0)
op7_117 = FillNA(op7_116, "lv", 0)
op7_118 = FillNA(op7_117, "mai", 0)
op7_119 = FillNA(op7_118, "mg", 0)
op7_120 = FillNA(op7_119, "mi", 0)
op7_121 = FillNA(op7_120, "min", 0)
op7_122 = FillNA(op7_121, "mk", 0)
op7_123 = FillNA(op7_122, "ml", 0)
op7_124 = FillNA(op7_123, "mn", 0)
op7_125 = FillNA(op7_124, "mr", 0)
op7_126 = FillNA(op7_125, "ms", 0)
op7_127 = FillNA(op7_126, "mt", 0)
op7_128 = FillNA(op7_127, "mwl", 0)
op7_129 = FillNA(op7_128, "my", 0)
op7_130 = FillNA(op7_129, "myv", 0)
op7_131 = FillNA(op7_130, "mzn", 0)
op7_132 = FillNA(op7_131, "nap", 0)
op7_133 = FillNA(op7_132, "nb", 0)
op7_134 = FillNA(op7_133, "nds", 0)
op7_135 = FillNA(op7_134, "nds-nl", 0)
op7_136 = FillNA(op7_135, "ne", 0)
op7_137 = FillNA(op7_136, "nl", 0)
op7_138 = FillNA(op7_137, "nn", 0)
op7_139 = FillNA(op7_138, "no", 0)
op7_140 = FillNA(op7_139, "nov", 0)
op7_141 = FillNA(op7_140, "nrm", 0)
op7_142 = FillNA(op7_141, "nso", 0)
op7_143 = FillNA(op7_142, "oc", 0)
op7_144 = FillNA(op7_143, "olo", 0)
op7_145 = FillNA(op7_144, "or", 0)
op7_146 = FillNA(op7_145, "pa", 0)
op7_147 = FillNA(op7_146, "pam", 0)
op7_148 = FillNA(op7_147, "pcd", 0)
op7_149 = FillNA(op7_148, "pdc", 0)
op7_150 = FillNA(op7_149, "pfl", 0)
op7_151 = FillNA(op7_150, "pi", 0)
op7_152 = FillNA(op7_151, "pl", 0)
op7_153 = FillNA(op7_152, "pms", 0)
op7_154 = FillNA(op7_153, "ps", 0)
op7_155 = FillNA(op7_154, "pt", 0)
op7_156 = FillNA(op7_155, "pt-br", 0)
op7_157 = FillNA(op7_156, "qu", 0)
op7_158 = FillNA(op7_157, "rm", 0)
op7_159 = FillNA(op7_158, "ro", 0)
op7_160 = FillNA(op7_159, "roa-tara", 0)
op7_161 = FillNA(op7_160, "ru", 0)
op7_162 = FillNA(op7_161, "sa", 0)
op7_163 = FillNA(op7_162, "sah", 0)
op7_164 = FillNA(op7_163, "sc", 0)
op7_165 = FillNA(op7_164, "scn", 0)
op7_166 = FillNA(op7_165, "sco", 0)
op7_167 = FillNA(op7_166, "sd", 0)
op7_168 = FillNA(op7_167, "se", 0)
op7_169 = FillNA(op7_168, "sei", 0)
op7_170 = FillNA(op7_169, "sgs", 0)
op7_171 = FillNA(op7_170, "sh", 0)
op7_172 = FillNA(op7_171, "shi", 0)
op7_173 = FillNA(op7_172, "shi-tfng", 0)
op7_174 = FillNA(op7_173, "si", 0)
op7_175 = FillNA(op7_174, "simple", 0)
op7_176 = FillNA(op7_175, "sk", 0)
op7_177 = FillNA(op7_176, "skr-arab", 0)
op7_178 = FillNA(op7_177, "sl", 0)
op7_179 = FillNA(op7_178, "sma", 0)
op7_180 = FillNA(op7_179, "smj", 0)
op7_181 = FillNA(op7_180, "sq", 0)
op7_182 = FillNA(op7_181, "sr", 0)
op7_183 = FillNA(op7_182, "sr-ec", 0)
op7_184 = FillNA(op7_183, "sr-el", 0)
op7_185 = FillNA(op7_184, "stq", 0)
op7_186 = FillNA(op7_185, "su", 0)
op7_187 = FillNA(op7_186, "sv", 0)
op7_188 = FillNA(op7_187, "sw", 0)
op7_189 = FillNA(op7_188, "szl", 0)
op7_190 = FillNA(op7_189, "ta", 0)
op7_191 = FillNA(op7_190, "tcy", 0)
op7_192 = FillNA(op7_191, "te", 0)
op7_193 = FillNA(op7_192, "tg", 0)
op7_194 = FillNA(op7_193, "tg-cyrl", 0)
op7_195 = FillNA(op7_194, "th", 0)
op7_196 = FillNA(op7_195, "tl", 0)
op7_197 = FillNA(op7_196, "tokipona", 0)
op7_198 = FillNA(op7_197, "tr", 0)
op7_199 = FillNA(op7_198, "ts", 0)
op7_200 = FillNA(op7_199, "tt", 0)
op7_201 = FillNA(op7_200, "tt-cyrl", 0)
op7_202 = FillNA(op7_201, "tt-latn", 0)
op7_203 = FillNA(op7_202, "ty", 0)
op7_204 = FillNA(op7_203, "udm", 0)
op7_205 = FillNA(op7_204, "uk", 0)
op7_206 = FillNA(op7_205, "ur", 0)
op7_207 = FillNA(op7_206, "uz", 0)
op7_208 = FillNA(op7_207, "vec", 0)
op7_209 = FillNA(op7_208, "vi", 0)
op7_210 = FillNA(op7_209, "vls", 0)
op7_211 = FillNA(op7_210, "vmf", 0)
op7_212 = FillNA(op7_211, "vo", 0)
op7_213 = FillNA(op7_212, "wa", 0)
op7_214 = FillNA(op7_213, "war", 0)
op7_215 = FillNA(op7_214, "wo", 0)
op7_216 = FillNA(op7_215, "wuu", 0)
op7_217 = FillNA(op7_216, "xh", 0)
op7_218 = FillNA(op7_217, "yi", 0)
op7_219 = FillNA(op7_218, "yo", 0)
op7_220 = FillNA(op7_219, "yue", 0)
op7_221 = FillNA(op7_220, "za", 0)
op7_222 = FillNA(op7_221, "zea", 0)
op7_223 = FillNA(op7_222, "zh", 0)
op7_224 = FillNA(op7_223, "zh-cn", 0)
op7_225 = FillNA(op7_224, "zh-hans", 0)
op7_226 = FillNA(op7_225, "zh-hant", 0)
op7_227 = FillNA(op7_226, "zh-hk", 0)
op7_228 = FillNA(op7_227, "zh-mo", 0)
op7_229 = FillNA(op7_228, "zh-my", 0)
op7_230 = FillNA(op7_229, "zh-sg", 0)
op7_231 = FillNA(op7_230, "zh-tw", 0)
op7_232 = FillNA(op7_231, "zh-yue", 0)
op8 = FillNA(op7_232, "zu", 0)

#ops = [op0, op1, op2, op3, op4, op7, op7_0, op7_1, op7_2, op7_3, op7_4, op7_5, op7_6, op7_7, op7_8, op7_9, op7_10, op7_11, op7_12, op7_13, op7_14, op7_15, op7_16, op7_17, op7_18, op7_19, op7_20, op7_21, op7_22, op7_23, op7_24, op7_25, op7_26, op7_27, op7_28, op7_29, op7_30, op7_31, op7_32, op7_33, op7_34, op7_35, op7_36, op7_37, op7_38, op7_39, op7_40, op7_41, op7_42, op7_43, op7_44, op7_45, op7_46, op7_47, op7_48, op7_49, op7_50, op7_51, op7_52, op7_53, op7_54, op7_55, op7_56, op7_57, op7_58, op7_59, op7_60, op7_61, op7_62, op7_63, op7_64, op7_65, op7_66, op7_67, op7_68, op7_69, op7_70, op7_71, op7_72, op7_73, op7_74, op7_75, op7_76, op7_77, op7_78, op7_79, op7_80, op7_81, op7_82, op7_83, op7_84, op7_85, op7_86, op7_87, op7_88, op7_89, op7_90, op7_91, op7_92, op7_93, op7_94, op7_95, op7_96, op7_97, op7_98, op7_99, op7_100, op7_101, op7_102, op7_103, op7_104, op7_105, op7_106, op7_107, op7_108, op7_109, op7_110, op7_111, op7_112, op7_113, op7_114, op7_115, op7_116, op7_117, op7_118, op7_119, op7_120, op7_121, op7_122, op7_123, op7_124, op7_125, op7_126, op7_127, op7_128, op7_129, op7_130, op7_131, op7_132, op7_133, op7_134, op7_135, op7_136, op7_137, op7_138, op7_139, op7_140, op7_141, op7_142, op7_143, op7_144, op7_145, op7_146, op7_147, op7_148, op7_149, op7_150, op7_151, op7_152, op7_153, op7_154, op7_155, op7_156, op7_157, op7_158, op7_159, op7_160, op7_161, op7_162, op7_163, op7_164, op7_165, op7_166, op7_167, op7_168, op7_169, op7_170, op7_171, op7_172, op7_173, op7_174, op7_175, op7_176, op7_177, op7_178, op7_179, op7_180, op7_181, op7_182, op7_183, op7_184, op7_185, op7_186, op7_187, op7_188, op7_189, op7_190, op7_191, op7_192, op7_193, op7_194, op7_195, op7_196, op7_197, op7_198, op7_199, op7_200, op7_201, op7_202, op7_203, op7_204, op7_205, op7_206, op7_207, op7_208, op7_209, op7_210, op7_211, op7_212, op7_213, op7_214, op7_215, op7_216, op7_217, op7_218, op7_219, op7_220, op7_221, op7_222, op7_223, op7_224, op7_225, op7_226, op7_227, op7_228, op7_229, op7_230, op7_231, op7_232, op8]
ops = [op0, op1, op2, op3, op4, op7]
output_schemas = generate_output_schemas(ops)


def mkdir(path):
    folder = os.path.exists(path)
    if not folder:
        os.makedirs(path)
    
mkdir('./temp')


output_filter = get_output_filter(ops, './temp')
print("The output filter is:")
print(output_filter)
#print(output_filter)
#print(output_filter)
#exit(0)
for op_id,op_i in reversed([(k1,v1) for k1,v1 in enumerate(ops)]):
    if(op_i == ops[-1]):
        output_filter_i = {None:output_filter}
    else:
        output_filter_i = generate_output_filter_from_previous(op_i, ops)
    inference_i = op_i.get_inference_instance(output_filter_i)
    inference_i.input_filters = generate_input_filters(op_i, inference_i, AllOr(*list(output_filter_i.values())))
    # print(output_filter_i)
    print(op_id, ':')
    print_input_filters(inference_i)
    #print(inference_i.output_filter)

check_pushdown_result(ops, 'temp/')
